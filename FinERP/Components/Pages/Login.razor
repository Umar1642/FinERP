@page "/login"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using FinERP.Security

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IDbContextFactory<FinERP.Data.AppDbContext> DbFactory

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudCard Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
            FinERP Login
        </MudText>
        
        <MudTextField @bind-Value="email" Label="Email"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Class="mb-4" />

        <MudTextField @bind-Value="password" Label="Password"
                      InputType="InputType.Password"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Class="mb-6" />
        
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   FullWidth="true"
                   Size="Size.Large"
                   OnClick="HandleLogin">
            Sign In
        </MudButton>
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudText Color="Color.Error"
                     Align="Align.Center"
                     Class="mt-4">
                @errorMessage
            </MudText>
        }
    </MudCard>
</MudContainer>

@code {
    private string email = "";
    private string password = "";
    private string errorMessage = "";

    private async Task HandleLogin()
    {
        using var dbContext = DbFactory.CreateDbContext();

        var user = await dbContext.Users
            .FirstOrDefaultAsync(u => u.Email == email);

        if (user != null)
        {
            var passwordService = new PasswordService();

            if (passwordService.VerifyPassword(user, password))
            {
                if (AuthenticationStateProvider is FakeAuthStateProvider customProvider)
                {
                    customProvider.MarkUserAsAuthenticated(email);
                    NavigationManager.NavigateTo("/salary");
                    return;
                }
            }
        }

        errorMessage = "Invalid email or password.";
    }
}